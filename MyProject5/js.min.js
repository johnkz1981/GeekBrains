"use strict";

/**
 * Проверка есть ли корзина в localStorage
 * Если нет, то создает
 */
if (!localStorage.getItem("cart")) {
  let productsInCart = [];
  localStorage.setItem("cart", JSON.stringify(productsInCart));
}

/**
 * Записывает из localStorage данные в массив
 */
let productsInCart = JSON.parse(localStorage.getItem("cart"));


/**
 * Объект корзины
 */
const cart = {
  /**
   * Первоначальные данные общего количества и конечной цены
   */
  totalCartSettings: {
    totalQty: 0,
    totalPrice: 0
  },

  /**
   * Считает общее количество и окончательную цену исходя из товаров в корзине
   */
  createTotalCartSettings() {
    for (let i = 0; i < productsInCart.length; i++) {
      this.totalCartSettings.totalQty += productsInCart[i].qty;
      this.totalCartSettings.totalPrice += productsInCart[i].price * productsInCart[i].qty;
    }
  },

  /**
   * Инициализинует корзину
   */
  init() {
    const buttonArray = document.querySelectorAll('.add-cart');
    this.createTotalCartSettings();
    this.outputQtyTotalPrice();
    this.createListContainer();
    this.addProductToCart(buttonArray);
  },

  /**
   * Выводит общее количество и окончательную цену
   */
  outputQtyTotalPrice() {

    if (this.totalCartSettings.totalQty > 0) {
      document.querySelector('.totalQty').classList.add('active');
    } else {
      document.querySelector('.totalQty').classList.remove('active');
    }
    document.querySelector('.totalQty').innerHTML = this.totalCartSettings.totalQty;
    document.querySelector('.totalPrice_price').innerHTML = this.totalCartSettings.totalPrice;
  },

  addProductToCart(buttonArray) {
    for (let i = 0; i < buttonArray.length; i++) {
      buttonArray[i].addEventListener('click', (event) => this.addToCart(event), true)
    }
  },

  /**
   * Добавляет товар в корзину
   * @param {MouseEvent} event Событие клика мышью
   */
  addToCart(event) {
    this.checkForAvailability(event);
    this.createListContainer();
    this.changeTotalCounter(event);
  },

  /**
   * Проверяет есть ли такой товар в корзине
   * @param {MouseEvent} event Событие клика мышью
   */
  checkForAvailability(event) {
    let id = null;
    for (let item of event.composedPath()) {
      if (item.className === 'add-cart') {
        id = +item.dataset.id;
      }
    }
    for (let i = 0; i < productsInCart.length; i++) {
      if (productsInCart[i].id === id) {
        productsInCart[i].qty += 1;
        localStorage.setItem("cart", JSON.stringify(productsInCart));
        return;
      }
    }
    this.addNewProduct(event);
  },

  /**
   * Добавляет товар в корзину если его там нет
   * @param {MouseEvent} event Событие клика мышью
   */
  addNewProduct(event) {
    for (let item of event.composedPath()) {
      if (item.className === 'add-cart') {
        productsInCart.push({
          'id': +item.dataset.id,
          'name': item.dataset.name,
          'price': +item.dataset.price,
          'img': item.dataset.img,
          'qty': 1,
        });
      }
    }
    localStorage.setItem("cart", JSON.stringify(productsInCart));
  },

  /**
   * Пересчитывет количество товара в корзине и общую стоимость
   * @param event
   */
  changeTotalCounter(event) {
    this.totalCartSettings.totalQty += 1;
    for (let item of event.composedPath()) {
      if (item.className === 'add-cart') {
        this.totalCartSettings.totalPrice += +item.dataset.price;
      }
    }
    this.outputQtyTotalPrice();
  },

  /**
   * Выводит товары в корзину
   */
  createListContainer() {
    let html = '';
    const productsInCartContainer = document.querySelector('.productsInCart');
    productsInCartContainer.innerHTML = html;

    for (let i = 0; i < productsInCart.length; i++) {
      const productWrap = document.createElement('article');
      productWrap.classList.add('item');
      productsInCartContainer.appendChild(productWrap);

      const imgLink = document.createElement('a');
      imgLink.setAttribute('href', 'single-page.html?id=' + productsInCart[i].id);
      imgLink.classList.add('productCartCard_image');
      productWrap.appendChild(imgLink);

      const image = new Image();
      image.src = `img/${productsInCart[i].img}`;
      image.alt = productsInCart[i].name;
      imgLink.appendChild(image);

      const productInfo = document.createElement('div');
      productInfo.classList.add('productCartInfo');
      productWrap.appendChild(productInfo);

      const productName = document.createElement('div');
      productName.classList.add('caption');
      productName.innerHTML = productsInCart[i].name;
      productInfo.appendChild(productName);

      const productRating = document.createElement('div');
      productRating.classList.add('star');
      productInfo.appendChild(productRating);

      const reitng = 4.5;
      for (let i = 0; i < Math.round(reitng); i++) {
        const productRatingElem = document.createElement('i');
        productRatingElem.classList.add('fas');

        if (i === (Math.round(reitng) - 1) && reitng !== Math.round(reitng)) {
          productRatingElem.classList.add('fa-star-half-alt');
        } else {
          productRatingElem.classList.add('fa-star');
        }
        productRating.appendChild(productRatingElem);
      }

      const productPrice = document.createElement('div');
      productPrice.classList.add('productCartPrice');
      productPrice.classList.add('price');
      productPrice.innerHTML = `${productsInCart[i].qty} x 
                                      <span class="productCartPrice"> $${productsInCart[i].price} </span>`;
      productInfo.appendChild(productPrice);

      const productButtonWrap = document.createElement('div');
      productButtonWrap.classList.add('close');
      productWrap.appendChild(productButtonWrap);

      const productButton = document.createElement('i');
      productButton.classList.add('productCartButton');
      productButton.innerHTML = `<i class ="fas fa-times-circle"></i>`;
      productButton.setAttribute('data-id', productsInCart[i].id);
      productButton.addEventListener('click', (event) => {
        event.stopPropagation();
        this.deleteFromCart(event)
      });
      productButtonWrap.appendChild(productButton);

      const hr = document.createElement('div');
      hr.classList.add('hr');
      productsInCartContainer.appendChild(hr);

      const h4 = document.createElement('h4');
      hr.classList.add('h4');
      productsInCartContainer.appendChild(h4);
    }
  }
  ,

  /**
   * Удаляет товар из корзины
   * @param {MouseEvent} event Событие клика мышью
   */
  deleteFromCart(event) {
    let id = null;
    for (let item of event.composedPath()) {
      if (item.className === 'productCartButton' || item.className === 'action') {
        id = +item.dataset.id;
      }
    }
    for (let i = 0; i < productsInCart.length; i++) {
      if (productsInCart[i].id === id) {
        this.totalCartSettings.totalQty -= productsInCart[i].qty;
        this.totalCartSettings.totalPrice -= productsInCart[i].price * productsInCart[i].qty;
        productsInCart.splice(i, 1);
      }
    }
    this.createListContainer();
    this.outputQtyTotalPrice();
    localStorage.setItem("cart", JSON.stringify(productsInCart));
  }
  ,
};

/**
 * Объект карзины, для вывода на страницу
 */
const pageCart = {
  init() {
    this.createCart()
  },
  createCart() {
    const cartContainer = $('.cart__table');
    cartContainer.html('');
    for (let i = 0; i < productsInCart.length; i++) {
      let detail = $(`<div class="detail">
      <div class="product-details">
        <a href="single-page.html">
          <img src="${'img/' + productsInCart[i].img}" alt="">
        </a>
        <div>
          <a href="single-page.html"><h3>${productsInCart[i].name}</h3></a>
          <p>
            <span>Color:</span>Red
          </p>
          <p>
            <span>Size:</span>XII
          </p>
        </div>
      </div>
      <div class="unite-price">$${productsInCart[i].price}</div>
      <div class="quantity">
        <input type="number" min="1" value="${productsInCart[i].qty}">
      </div>
      <div class="shipping">FREE</div>
      <div class="subtotal">$${productsInCart[i].price * productsInCart[i].qty}</div>
      <div class="action" data-id="${productsInCart[i].id}">
        <i class="fas fa-times-circle"></i>
      </div>
    </div>
    <div class="hr"></div>`);

      detail.appendTo(cartContainer);
    }
    const action = document.querySelectorAll('.action');
    for (const actionItem of action) {
      actionItem.addEventListener('click', evt => {
        this.refreshCart(evt);
      })
    }
  },

  refreshCart(event) {
    cart.deleteFromCart(event);
    this.createCart();
  }
};
"use strict";

const productsContainer = $('.product-wrapper');
const productsContainerCatalog = $('.catalog-products-cart');
const productsContainerSingle = $('.may-like');
productsContainer.html('');
productsContainerCatalog.html('');
productsContainerSingle.html('');

fetch('json/productsData.json')
    .then(result => {
      return result.json();
    })
    .then(productJson => {
      for (let i = 0; i < 9; i++) {
        let product = new ProductCart(productJson[i].id, productJson[i].title, productJson[i].image, productJson[i].price, productJson[i].rating,
            'product', 'image-product', 'text-product', 'product__rating', 'product__price',
            'product__price_btn add_to_cart', 'products.html?id=' + productJson.id);
        productsContainerCatalog.append(product.render());
        if (i < 8) {
          productsContainer.append(product.render());
        }
        if (i < 4) {
          productsContainerSingle.append(product.render());
        }
      }
    })
    .catch(error => console.log(error));

window.onload = () => {
  const cartHover = document.querySelector('.cart');
  cartHover.addEventListener('click', evt => {
    //evt.preventDefault();
    cartHover.classList.toggle('active');
  });
  cart.init();
  pageCart.init();
};
"use strict";

class Products {
  constructor(productId, productName, productImg, productPrice, productRating) {
    this.productId = productId;
    this.productName = productName;
    this.productImg = productImg;
    this.productPrice = productPrice;
    this.productRating = productRating;
  }
}

class ProductCart extends Products {
  constructor(productId, productName, productImg, productPrice, productRating, productCartClass, productImgClass,
              productNameClass, productRatingClass, productPriceClass, productBtnClass, productLink) {
    super(productId, productName, productImg, productPrice, productRating);
    this.productCartClass = productCartClass;
    this.productImgClass = productImgClass;
    this.productNameClass = productNameClass;
    this.productRatingClass = productRatingClass;
    this.productPriceClass = productPriceClass;
    this.productBtnClass = productBtnClass;
    this.productLink = productLink;
  }

  render() {
    const result =
    `<div class="product ">
    <div class="image-product ">
      <a href="single-page.html">
        <img src="img/${this.productImg}" alt=" ${this.productName } ">
      </a>
      <div class="add-cart"
           data-name="${this.productName }"
           data-price="${this.productPrice}"
           data-id="${this.productId}"
           data-img="${this.productImg}">
        <img src="img/basket2.svg " alt="Cart ">
        <span>Add to Cart</span>
      </div>
    </div>
    <a href="single-page.html">
      <div class="text-product ">
        <p>${this.productName }</p>
        <p>
          <span>${this.productPrice }</span>
        </p>
      </div>
    </a>
  </div>`;

    return result;
  }
}

class SingleProduct extends Products {
  constructor(productId, productName, productImg, productPrice, productRating, productImgClass,
              productNameClass, productRatingClass, productPriceClass, productBtnClass, productDescription1,
              productDescription2, productDescription3) {
    super(productId, productName, productImg, productPrice, productRating);
    this.productImgClass = productImgClass;
    this.productNameClass = productNameClass;
    this.productRatingClass = productRatingClass;
    this.productPriceClass = productPriceClass;
    this.productBtnClass = productBtnClass;
    this.productDescription1 = productDescription1;
    this.productDescription2 = productDescription2;
    this.productDescription3 = productDescription3;
  }

  render() {
    let result = '<div class="col-md-4 col-sm-12 product__info__left">';
    result += '<div class="' + this.productImgClass + '">';
    result += '<img src="img/' + this.productImg + '" alt="' + this.productName + '">';
    result += '</div>';
    result += '<button class="' + this.productBtnClass + '" data-id="' + this.productId
        + '" data-name="' + this.productName + '" data-img="' + this.productImg
        + '" data-price="' + this.productPrice + '">';
    result += 'Купить';
    result += '</button>';
    result += '</div>';
    result += '<div class="col-md-7 col-md-offset-1 col-sm-12 product__info__right">';
    result += '<h3 class="' + this.productNameClass + '">';
    result += this.productName;
    result += '</h3>';
    result += '<p class="' + this.productPriceClass + '">';
    result += 'Цена: ' + this.productPrice + ' руб.';
    result += '</p>';
    result += '<div class="' + this.productRatingClass + '">';
    for (let i = 0; i < Math.round(this.productRating); i++) {
      result += '<i class="fas fa-star"></i>';
    }
    for (let i = 0; i < (5 - Math.round(this.productRating)); i++) {
      result += '<i class="far fa-star"></i>';
    }
    result += '</div>';
    result += this.renderTab();
    result += '</div>';

    return result;
  }

  renderTab() {
    let result = '<div class="tab">';
    result += '<ul class="tab__item">';
    result += '<li class="active">1</li>';
    result += '<li>2</li>';
    result += '<li>3</li>';
    result += '</ul>';
    result += '<div class="desc1 tab__description active">' + this.productDescription1 + '</div>';
    result += '<div class="desc2 tab__description">' + this.productDescription2 + '</div>';
    result += '<div class="desc3 tab__description">' + this.productDescription3 + '</div>';
    result += '</div>';

    return result;
  }
}

class RecommendationProduct extends Products {
  constructor(productId, productName, productImg) {
    super(productId, productName, productImg);
  }

  render() {
    let result = '<a href="products.html?id=' + this.productId + '">';
    result += '<img src="img/' + this.productImg + '" alt="' + this.productName + '">';
    result += '</a>';
    return result;
  }
}